<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Transportation Scheduler</title>
    <link rel="stylesheet" href="assets/css/styles.css">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <style>
        body {
            background-color: gray;
        }

        body::after {
        content: "";
        background: url(/assets/images/1200px-Engelberg_Bahnhof_2013-02-05.jpg);
        background-size: cover;
        opacity: 0.4;
        top: 0;
        left: 0;
        bottom: -30px;
        right: 0;
        position: fixed;
        z-index: -1;   
        }

        /* STYLES FOR SWISS RAILWAY CLOCK BELOW */
        /* Swiss Railway Clock by Richard Beddington  */
        /* https: //codepen.io/RichieAHB/ */

        *,
        :before,
        :after {
            box-sizing: border-box;
        }

        .clock {
            /* left: 0px; */
            /* position: absolute; */
            /* top: 0; */
            width: 100%;
            /* border: .1px solid red; */

        }

        #clockbox {
            /* height: 300px; */
            width: 100%;
            margin: 0 auto;
            /* text-align: center; */
            /* border: .1px solid red; */

        }

        /* STYLES FOR SWISS RAILWAY CLOCK ABOVE */


        .jumbotron {
            margin-top: 20px;
            background-color: rgb(226, 237, 250);
        }

        .card {
            margin-bottom: 30px;
        }
    </style>
</head>

<body>

    <div class="container">

        <div class="jumbotron">
            <div id="clockbox">
                <canvas id="clock" class="clock"></canvas>
            </div>
        </div>

        <div class="card">
            <h5 class="card-header bg-primary text-light">Current Train Schedule</h5>
            <div class="card-body">
                <table class="table table-striped table-hover table-responsive-md">
                    <thead>
                        <tr class="text-primary">
                            <th scope="col">Train Name</th>
                            <th scope="col">Route</th>
                            <th scope="col">Frequency (min)</th>
                            <th scope="col">Next Arrival</th>
                            <th scope="col">Minutes Away</th>
                        </tr>
                    </thead>
                    <tbody id="train_list">
                        <tr>
                            <th scope="row">Trans-Siberian Express</th>
                            <td>Moscow-Vladivostok</td>
                            <td>25</td>
                            <td>05:35 PM</td>
                            <td>10</td>
                        </tr>
                        <!-- <tr>
                            <th scope="row">Orient Express</th>
                            <td>Paris-Constantinople</td>
                            <td>3600</td>
                            <td>01:39 PM</td>
                            <td>1154</td>
                        </tr>
                        <tr>
                            <th scope="row">Flying Scotsman</th>
                            <td>London-Edinburgh</td>
                            <td>15</td>
                            <td>05:35 PM</td>
                            <td>10</td>
                        </tr>
                        <tr>
                            <th scope="row">Blue Train</th>
                            <td>Cape Town-Pretoria</td>
                            <td>45</td>
                            <td>05:53 PM</td>
                            <td>28</td>
                        </tr>
                        <tr>
                            <th scope="row">Shinkansen</th>
                            <td>Tokyo-Nagoya</td>
                            <td>65</td>
                            <td>05:50 PM</td>
                            <td>25</td>
                        </tr>
                        <tr>
                            <th scope="row">Eurostar</th>
                            <td>London-Paris</td>
                            <td>6000</td>
                            <td>01:25 AM</td>
                            <td>4740</td>
                        </tr>
                        <tr>
                            <th scope="row">Ghan</th>
                            <td>Adelaide-Darwin</td>
                            <td>25</td>
                            <td>05:28 PM</td>
                            <td>3</td>
                        </tr> -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h5 class="card-header bg-primary text-light">Add Train</h5>
            <div class="card-body">
                <form>
                    <div class="form-group">
                        <label class="font-weight-bold" for="train_name">Train Name</label>
                        <input type="text" class="form-control" id="train_name" placeholder="name of a new train route">
                    </div>
                    <div class="form-group">
                        <label class="font-weight-bold" for="train_route">Route</label>
                        <input type="text" class="form-control" id="train_route" placeholder="final destination of train route">
                    </div>
                    <div class="form-group">
                        <label for="train_first">
                            <span class="font-weight-bold">First Train Time</span>
                            <span class="font-italic font-weight-light">(HH:mm, 24h military time)</span>
                        </label>
                        <input type="text" class="form-control" id="train_first" placeholder="arrival time of first train">
                    </div>
                    <div class="form-group">
                        <label class="font-weight-bold" for="train_freq">Frequency</label>
                        <input type="text" class="form-control" id="train_freq" placeholder="number of minutes between each train">
                    </div>
                    <button id="add_train_btn" type="submit" class="btn btn-primary">Submit</button>
                </form>
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/5.4.1/firebase.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <script src="assets/js/swissrail.js"></script>
    <script src="assets/js/scripts.js"></script>

    <script>
        // ==========================================================
        // CONNECT TO FIREBASE REALTIME DATABASE
        // ==========================================================

        // initialize variable with Firebase credentials
        var config = {
            apiKey: "AIzaSyCAlKIQlCVpzuFGD4nNsXqistWoyzM5wcE",
            authDomain: "trainschedule-a52e0.firebaseapp.com",
            databaseURL: "https://trainschedule-a52e0.firebaseio.com",
            projectId: "trainschedule-a52e0",
            storageBucket: "trainschedule-a52e0.appspot.com",
            messagingSenderId: "619259019326"
        };
        // initalize Firebase, send credentials
        firebase.initializeApp(config);
        // create a reference to the Firebase Realtime Database
        var db = firebase.database();


        // ==========================================================
        // INITIALIZE VARIABLES FOR STORED DATA
        // ==========================================================

        var trainName = "";
        var trainRoute = "";
        var trainFirst = "";
        var trainFreq = 0;


        // ==========================================================
        // SUBMIT BUTTON BELOW - SENDS NEW TRAIN TO DATABASE
        // ==========================================================

        $("#add_train_btn").on("click", function () {

            event.preventDefault();

            trainName = $("#train_name").val().trim();
            trainRoute = $("#train_route").val().trim();
            trainFirst = $("#train_first").val().trim();
            trainFreq = $("#train_freq").val().trim();

            // console.log(trainName);
            // console.log(trainRoute);
            // console.log(trainFirst);
            // console.log(trainFreq);

            var addTrain = {
                name: trainName,
                route: trainRoute,
                first: trainFirst,
                freq: trainFreq,
            }

            console.log(addTrain);

            // .push() a new data set object to root level of database
            db.ref().push(addTrain);

            $("#train_name").val("");
            $("#train_route").val("");
            $("#train_first").val("");
            $("#train_freq").val("");

        });



        // ==========================================================
        // MINUTES AWAY AND NEXT ARRIVAL CALCULATIONS BELOW
        // ==========================================================

        // // trainFirst = "03:10";
        // // trainFreq = 30;

        // // create a MomentJS object, which is today's date, but pushed back one year,
        // // and the time is MILITARY HOURS (HH) as set in the var trainFirst
        // var trainFirstConverted = moment(trainFirst, "HH:mm").subtract(1, "years");
        // // console.log(trainFirstConverted);

        // // create a MomentJS current time object by just calling: moment()
        // var currentTime = moment();
        // // console the current time with a label, and print it as CIVILIAN HOURS (hh)
        // // pass the currentTime object into moment(), then .format it's output
        // // console.log("CURRENT TIME: " + moment(currentTime).format("hh:mm"));

        // // get difference in minutes between Now and trainFirstConverted objects
        // // this gives 365 days worth of minutes, +/- the difference btw Now + trainFirst
        // var timeDiffMinutes = moment().diff(moment(trainFirstConverted), "minutes");
        // // console.log("DIFFERENCE IN TIME: " + timeDiffMinutes);

        // // get the remainder (MODULUS %) of dividing timeDiffMinutes by / trainFreq
        // var timeRemainder = timeDiffMinutes % trainFreq;
        // // console.log(timeRemainder);

        // // MINUTES AWAY from next train arrival is
        // // trainFreq minus timeRemainder
        // var nextTrainMinutes = trainFreq - timeRemainder;
        // console.log("MINUTES TILL TRAIN: " + nextTrainMinutes);

        // // TIME OF NEXT ARRIVAL
        // // get Now, moment(), and .add
        // var nextTrain = moment().add(nextTrainMinutes, "minutes");
        // // console.log("ARRIVAL TIME: " + moment(nextTrain).format("hh:mm"));
        // var nextArrival = moment(nextTrain).format("hh:mm A");
        // console.log(nextArrival);


        // ==========================================================
        // EVENT LISTENER ADDS NEW DATABASE TRAINS TO THE PAGE'S SCHEDULE
        // ==========================================================

        // watch the root top level of database for any child data set objects added
        db.ref().on("child_added", function (childSnapshot) {

            // when a data object is added, console log the values of all the childSnapshot's data properties 
            console.log(childSnapshot.val().name);
            // console.log(childSnapshot.val().route);
            // console.log(childSnapshot.val().first);
            console.log(childSnapshot.val().freq);
            // console.log(childSnapshot.val());

            trainFirst = "03:10";
            trainFreq = 30;

            // create a MomentJS object, which is today's date, but pushed back one year,
            // and the time is MILITARY HOURS (HH) as set in the var trainFirst
            var trainFirstConverted = moment(trainFirst, "HH:mm").subtract(1, "years");
            // console.log(trainFirstConverted);

            // create a MomentJS current time object by just calling: moment()
            var currentTime = moment();
            // console the current time with a label, and print it as CIVILIAN HOURS (hh)
            // pass the currentTime object into moment(), then .format it's output
            // console.log("CURRENT TIME: " + moment(currentTime).format("hh:mm"));

            // get difference in minutes between Now and trainFirstConverted objects
            // this gives 365 days worth of minutes, +/- the difference btw Now + trainFirst
            var timeDiffMinutes = moment().diff(moment(trainFirstConverted), "minutes");
            // console.log("DIFFERENCE IN TIME: " + timeDiffMinutes);

            // get the remainder (MODULUS %) of dividing timeDiffMinutes by / trainFreq
            var timeRemainder = timeDiffMinutes % trainFreq;
            // console.log(timeRemainder);

            // MINUTES AWAY from next train arrival is
            // trainFreq minus timeRemainder
            var nextTrainMinutes = trainFreq - timeRemainder;
            console.log("MINUTES TILL TRAIN: " + nextTrainMinutes);

            // TIME OF NEXT ARRIVAL
            // get Now, moment(), and .add
            var nextTrain = moment().add(nextTrainMinutes, "minutes");
            // console.log("ARRIVAL TIME: " + moment(nextTrain).format("hh:mm"));
            var nextArrival = moment(nextTrain).format("hh:mm A");
            console.log(nextArrival);


            // then .append a list of all the new data object's properties to the All Members area of the page
            $("#train_list").append("<tr><th scope='row'>" + childSnapshot.val().name + "</th><td>" + childSnapshot.val().route + "</td><td>" + childSnapshot.val().freq + "</td><td>" + nextArrival + "</td><td>" + nextTrainMinutes + "</td></tr>");

            // and if any errors occur, send them to this function
        }, function (errorObject) {
            console.log("Errors handled: " + errorObject.code);
        });





        // // THIS CODE ADDS THE MOST RECENT MEMBER'S DATA TO THE "Most Recent Member" PAGE AREA
        // // when a child data object is added, .on("child_added",... to the root directory db.ref()
        // // set .orderByChild("dateAdded") to use dateAdded as the sorting order,
        // // and limitToLast(1) to only return the 1 most recent added data object (1 member)
        // db.ref().orderByChild("dateAdded").limitToLast(1).on("child_added", function (snapshot) {
        //     // Change the HTML to reflect
        //     $("#name-display").text(snapshot.val().name);
        //     $("#email-display").text(snapshot.val().email);
        //     $("#age-display").text(snapshot.val().age);
        //     $("#comment-display").text(snapshot.val().comment);
        //     console.log(snapshot.val());
        // });
    </script>
</body>

</html>